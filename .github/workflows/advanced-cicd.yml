# Day2 ì‹¤ìŠµìš© ê³ ê¸‰ CI/CD íŒŒì´í”„ë¼ì¸
name: Advanced CI/CD Pipeline

on:
  push:
    branches: [ day2-advanced, develop, feature/* ]
  pull_request:
    branches: [ day2-advanced, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ì„ ì„ íƒí•˜ì„¸ìš”'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  REGISTRY: docker.io
  IMAGE_NAME: github-actions-demo-day2

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ë¦°íŒ… ê²€ì‚¬
      run: npm run lint
      
    - name: ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬
      run: npm run format -- --check
      
    - name: ë³´ì•ˆ ê°ì‚¬
      run: npm audit --audit-level moderate
      
    - name: ì˜ì¡´ì„± ì·¨ì•½ì  ê²€ì‚¬
      run: |
        npm audit --audit-level high
        if [ $? -ne 0 ]; then
          echo "High severity vulnerabilities found"
          exit 1
        fi

  # ë©€í‹° í™˜ê²½ í…ŒìŠ¤íŠ¸
  test:
    name: ë©€í‹° í™˜ê²½ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      matrix:
        node-version: [16, 18, 20]
        environment: [staging, production]
    services:
      postgres:
        image: postgres:13-alpine
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: myapp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:6-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ${{ matrix.node-version }} ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: PostgreSQL í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
      
    - name: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      run: |
        echo "NODE_ENV=${{ matrix.environment }}" >> $GITHUB_ENV
        echo "DB_HOST=localhost" >> $GITHUB_ENV
        echo "DB_PORT=5432" >> $GITHUB_ENV
        echo "DB_NAME=myapp_test" >> $GITHUB_ENV
        echo "DB_USER=postgres" >> $GITHUB_ENV
        echo "DB_PASSWORD=password" >> $GITHUB_ENV
        echo "REDIS_HOST=localhost" >> $GITHUB_ENV
        echo "REDIS_PORT=6379" >> $GITHUB_ENV
        echo "REDIS_PASSWORD=" >> $GITHUB_ENV
        echo "PORT=3000" >> $GITHUB_ENV
      
    - name: ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
      run: |
        echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
        echo "í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
        echo "DB_HOST: $DB_HOST"
        echo "DB_PORT: $DB_PORT"
        echo "DB_NAME: $DB_NAME"
        echo "DB_USER: $DB_USER"
        echo "NODE_ENV: $NODE_ENV"
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ëŒ€ê¸°
        echo "â³ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
        timeout 60 bash -c 'until pg_isready -h localhost -p 5432 -U postgres; do sleep 2; done'
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì ì—­í•  ìƒì„±
        echo "ğŸ‘¤ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì ì—­í•  ìƒì„±..."
        PGPASSWORD=password psql -h localhost -p 5432 -U postgres -d myapp_test -c "
          DO \$\$
          BEGIN
              IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'myapp_user') THEN
                  CREATE ROLE myapp_user WITH LOGIN PASSWORD 'password';
              END IF;
          END
          \$\$;
          GRANT CONNECT ON DATABASE myapp_test TO myapp_user;
          GRANT USAGE ON SCHEMA public TO myapp_user;
          GRANT CREATE ON SCHEMA public TO myapp_user;
        " || echo "âš ï¸ ì‚¬ìš©ì ì—­í•  ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ (ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ)"
        
        # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
        echo "ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰..."
        npm run db:migrate
        
        # ì‹œë“œ ë°ì´í„° ì‹¤í–‰
        echo "ğŸŒ± ì‹œë“œ ë°ì´í„° ìƒì„±..."
        npm run db:seed
        
        echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ!"
      
    - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
      run: |
        echo "ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹œì‘í•©ë‹ˆë‹¤..."
        
        # í™˜ê²½ ë³€ìˆ˜ í™•ì¸
        echo "í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
        echo "PORT: $PORT"
        echo "DB_HOST: $DB_HOST"
        echo "DB_PORT: $DB_PORT"
        echo "DB_NAME: $DB_NAME"
        echo "DB_USER: $DB_USER"
        echo "REDIS_HOST: $REDIS_HOST"
        echo "REDIS_PORT: $REDIS_PORT"
        echo "REDIS_PASSWORD: '$REDIS_PASSWORD'"
        
        # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p logs
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
        npm start > app.log 2>&1 &
        APP_PID=$!
        echo "ì• í”Œë¦¬ì¼€ì´ì…˜ PID: $APP_PID"
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸°
        echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
        for i in {1..15}; do
          if curl -f http://localhost:3000/health >/dev/null 2>&1; then
            echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
            break
          fi
          echo "ì‹œë„ $i/15: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 2
        done
        
        # ìµœì¢… í™•ì¸
        if ! curl -f http://localhost:3000/health >/dev/null 2>&1; then
          echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹¤íŒ¨"
          echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸:"
          cat app.log || echo "ë¡œê·¸ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          echo "ì‹¤í–‰ ì¤‘ì¸ Node.js í”„ë¡œì„¸ìŠ¤:"
          ps aux | grep node || echo "Node.js í”„ë¡œì„¸ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          kill $APP_PID 2>/dev/null || true
          exit 1
        fi
      
    - name: í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬
      run: |
        echo "ğŸ§¹ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì¤‘..."
        PGPASSWORD=password psql -h localhost -p 5432 -U postgres -d myapp_test -c "
          DELETE FROM system_metrics WHERE metric_name LIKE 'test_%' OR metric_name LIKE '%test%';
          DELETE FROM app_logs WHERE message LIKE '%test%' OR message LIKE '%Test%';
          DELETE FROM users WHERE username LIKE '%test%' AND username NOT IN ('admin', 'testuser', 'demo');
        " || echo "í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ (ì¼ë¶€ ì˜¤ë¥˜ ë¬´ì‹œ)"
        echo "âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ"
      
    - name: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
      run: |
        echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
        
        # PostgreSQL ìƒíƒœ í™•ì¸
        echo "ğŸ“Š PostgreSQL ìƒíƒœ:"
        PGPASSWORD=password psql -h localhost -p 5432 -U postgres -d myapp_test -c "SELECT version();" || echo "PostgreSQL ì—°ê²° ì‹¤íŒ¨"
        
        # Redis ìƒíƒœ í™•ì¸
        echo "ğŸ”´ Redis ìƒíƒœ:"
        redis-cli -h localhost -p 6379 ping || echo "Redis ì—°ê²° ì‹¤íŒ¨"
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬
        echo "ğŸ¥ ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬:"
        timeout 30 bash -c 'until curl -f http://localhost:3000/health; do sleep 2; done' || echo "ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
      
    - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        echo "ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        
        # Jest ì‹¤í–‰ (ê°„ë‹¨í•œ ë°©ì‹)
        if timeout 60 npm run test:unit; then
          echo "âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì„±ê³µ"
        else
          echo "âŒ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          exit 1
        fi
      
    - name: í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        echo "ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        
        # Jest ì‹¤í–‰ (ê°„ë‹¨í•œ ë°©ì‹)
        if timeout 60 npm run test:integration; then
          echo "âœ… í†µí•© í…ŒìŠ¤íŠ¸ ì„±ê³µ"
        else
          echo "âŒ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          exit 1
        fi
      
    - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ë¦¬
      if: always()
      run: |
        echo "ğŸ§¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ë¦¬ ì¤‘..."
        pkill -f "node" || echo "Node.js í”„ë¡œì„¸ìŠ¤ê°€ ì´ë¯¸ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"
        echo "âœ… ì •ë¦¬ ì™„ë£Œ"
      

  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build-and-push:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: [quality-check, test]
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Docker Hub ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        platforms: linux/amd64
        tags: |
          ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:v2.0.0
        labels: |
          org.opencontainers.image.title=GitHub Actions Demo Day2
          org.opencontainers.image.description=Advanced CI/CD Pipeline Demo
          org.opencontainers.image.version=v2.0.0
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha

  # ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    name: ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    needs: [build-and-push]
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Trivy ë³´ì•ˆ ìŠ¤ìº”
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Trivy ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # AWS VM ë°°í¬
  deploy-aws:
    name: AWS VM ë°°í¬
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan]
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    environment: aws-staging
    steps:
    - name: AWS VM ë°°í¬
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.AWS_VM_HOST }}
        username: ${{ secrets.AWS_VM_USERNAME }}
        key: ${{ secrets.AWS_VM_SSH_KEY }}
        script: |
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export DB_PASSWORD="${{ secrets.AWS_DB_PASSWORD }}"
          export REDIS_PASSWORD="${{ secrets.AWS_REDIS_PASSWORD }}"
          
          # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€
          docker-compose -f docker-compose.prod.yml down
          
          # ìµœì‹  ì´ë¯¸ì§€ í’€
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # AWS VM ë°°í¬
          docker-compose -f docker-compose.prod.yml up -d
          
          # í—¬ìŠ¤ì²´í¬
          sleep 30
          curl -f http://localhost/health || exit 1
          
          # ë°°í¬ ì•Œë¦¼
          echo "âœ… AWS VM deployment completed successfully"
          echo "ğŸŒ Application URL: http://${{ secrets.AWS_VM_HOST }}"
          echo "ğŸ“Š Metrics URL: http://${{ secrets.AWS_VM_HOST }}/metrics"

  # GCP VM ë°°í¬
  deploy-gcp:
    name: GCP VM ë°°í¬
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan]
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    environment: gcp-staging
    steps:
    - name: GCP VM ë°°í¬
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export DB_PASSWORD="${{ secrets.GCP_DB_PASSWORD }}"
          export REDIS_PASSWORD="${{ secrets.GCP_REDIS_PASSWORD }}"
          
          # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€
          docker-compose -f docker-compose.prod.yml down
          
          # ìµœì‹  ì´ë¯¸ì§€ í’€
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # GCP VM ë°°í¬
          docker-compose -f docker-compose.prod.yml up -d
          
          # í—¬ìŠ¤ì²´í¬
          sleep 30
          curl -f http://localhost/health || exit 1
          
          # ë°°í¬ ì•Œë¦¼
          echo "âœ… GCP VM deployment completed successfully"
          echo "ğŸŒ Application URL: http://${{ secrets.GCP_VM_HOST }}"
          echo "ğŸ“Š Metrics URL: http://${{ secrets.GCP_VM_HOST }}/metrics"

  # AWS í”„ë¡œë•ì…˜ ë°°í¬
  deploy-aws-production:
    name: AWS í”„ë¡œë•ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    environment: aws-production
    steps:
    - name: AWS í”„ë¡œë•ì…˜ ë°°í¬
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.AWS_VM_HOST }}
        username: ${{ secrets.AWS_VM_USERNAME }}
        key: ${{ secrets.AWS_VM_SSH_KEY }}
        script: |
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export DB_PASSWORD="${{ secrets.AWS_DB_PASSWORD }}"
          export REDIS_PASSWORD="${{ secrets.AWS_REDIS_PASSWORD }}"
          
          # Blue-Green ë°°í¬ë¥¼ ìœ„í•œ ë°±ì—…
          docker-compose -f docker-compose.prod.yml down
          docker tag ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:backup-$(date +%Y%m%d-%H%M%S)
          
          # ìµœì‹  ì´ë¯¸ì§€ í’€
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # AWS í”„ë¡œë•ì…˜ ë°°í¬
          docker-compose -f docker-compose.prod.yml up -d
          
          # í—¬ìŠ¤ì²´í¬
          sleep 30
          curl -f http://localhost/health || exit 1
          
          # ë°°í¬ ì•Œë¦¼
          echo "ğŸš€ AWS Production deployment completed successfully"
          echo "ğŸŒ Application URL: http://${{ secrets.AWS_VM_HOST }}"
          echo "ğŸ“Š Metrics URL: http://${{ secrets.AWS_VM_HOST }}/metrics"
          
          # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬ (7ì¼ ì´ìƒ ëœ ì´ë¯¸ì§€)
          docker image prune -f --filter "until=168h"

  # GCP í”„ë¡œë•ì…˜ ë°°í¬
  deploy-gcp-production:
    name: GCP í”„ë¡œë•ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: [build-and-push, security-scan]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    environment: gcp-production
    steps:
    - name: GCP í”„ë¡œë•ì…˜ ë°°í¬
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export DB_PASSWORD="${{ secrets.GCP_DB_PASSWORD }}"
          export REDIS_PASSWORD="${{ secrets.GCP_REDIS_PASSWORD }}"
          
          # Blue-Green ë°°í¬ë¥¼ ìœ„í•œ ë°±ì—…
          docker-compose -f docker-compose.prod.yml down
          docker tag ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:backup-$(date +%Y%m%d-%H%M%S)
          
          # ìµœì‹  ì´ë¯¸ì§€ í’€
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # GCP í”„ë¡œë•ì…˜ ë°°í¬
          docker-compose -f docker-compose.prod.yml up -d
          
          # í—¬ìŠ¤ì²´í¬
          sleep 30
          curl -f http://localhost/health || exit 1
          
          # ë°°í¬ ì•Œë¦¼
          echo "ğŸš€ GCP Production deployment completed successfully"
          echo "ğŸŒ Application URL: http://${{ secrets.GCP_VM_HOST }}"
          echo "ğŸ“Š Metrics URL: http://${{ secrets.GCP_VM_HOST }}/metrics"
          
          # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬ (7ì¼ ì´ìƒ ëœ ì´ë¯¸ì§€)
          docker image prune -f --filter "until=168h"

  # ë°°í¬ í›„ í…ŒìŠ¤íŠ¸
  post-deployment-test:
    name: ë°°í¬ í›„ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [deploy-aws, deploy-gcp, deploy-aws-production, deploy-gcp-production]
    if: always() && (needs.deploy-aws.result == 'success' || needs.deploy-gcp.result == 'success' || needs.deploy-aws-production.result == 'success' || needs.deploy-gcp-production.result == 'success')
    steps:
    - name: ë°°í¬ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ í…ŒìŠ¤íŠ¸
      run: |
        # AWS ìŠ¤í…Œì´ì§• í™˜ê²½ í…ŒìŠ¤íŠ¸
        if [ "${{ needs.deploy-aws.result }}" == "success" ]; then
          echo "Testing AWS staging environment..."
          curl -f http://${{ secrets.AWS_VM_HOST }}/health
          curl -f http://${{ secrets.AWS_VM_HOST }}/api/users
          echo "âœ… AWS staging environment tests passed"
        fi
        
        # GCP ìŠ¤í…Œì´ì§• í™˜ê²½ í…ŒìŠ¤íŠ¸
        if [ "${{ needs.deploy-gcp.result }}" == "success" ]; then
          echo "Testing GCP staging environment..."
          curl -f http://${{ secrets.GCP_VM_HOST }}/health
          curl -f http://${{ secrets.GCP_VM_HOST }}/api/users
          echo "âœ… GCP staging environment tests passed"
        fi
        
        # AWS í”„ë¡œë•ì…˜ í™˜ê²½ í…ŒìŠ¤íŠ¸
        if [ "${{ needs.deploy-aws-production.result }}" == "success" ]; then
          echo "Testing AWS production environment..."
          curl -f http://${{ secrets.AWS_VM_HOST }}/health
          curl -f http://${{ secrets.AWS_VM_HOST }}/api/users
          echo "âœ… AWS production environment tests passed"
        fi
        
        # GCP í”„ë¡œë•ì…˜ í™˜ê²½ í…ŒìŠ¤íŠ¸
        if [ "${{ needs.deploy-gcp-production.result }}" == "success" ]; then
          echo "Testing GCP production environment..."
          curl -f http://${{ secrets.GCP_VM_HOST }}/health
          curl -f http://${{ secrets.GCP_VM_HOST }}/api/users
          echo "âœ… GCP production environment tests passed"
        fi

  # ì•Œë¦¼
  notify:
    name: ë°°í¬ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [deploy-aws, deploy-gcp, deploy-aws-production, deploy-gcp-production, post-deployment-test]
    if: always()
    steps:
    - name: ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      run: |
        echo "ğŸ¯ CI/CD Pipeline Summary"
        echo "=========================="
        echo "ğŸ“¦ Build: âœ… Success"
        echo "ğŸ§ª Tests: âœ… Success"
        echo "ğŸ”’ Security Scan: âœ… Success"
        echo "ğŸš€ AWS Staging: ${{ needs.deploy-aws.result }}"
        echo "ğŸš€ GCP Staging: ${{ needs.deploy-gcp.result }}"
        echo "ğŸ­ AWS Production: ${{ needs.deploy-aws-production.result }}"
        echo "ğŸ­ GCP Production: ${{ needs.deploy-gcp-production.result }}"
        echo "âœ… Post-deployment Tests: ${{ needs.post-deployment-test.result }}"
        echo ""
        echo "ğŸŒ Deployed URLs:"
        if [ "${{ needs.deploy-aws.result }}" == "success" ]; then
          echo "  AWS Staging: http://${{ secrets.AWS_VM_HOST }}"
        fi
        if [ "${{ needs.deploy-gcp.result }}" == "success" ]; then
          echo "  GCP Staging: http://${{ secrets.GCP_VM_HOST }}"
        fi
        if [ "${{ needs.deploy-aws-production.result }}" == "success" ]; then
          echo "  AWS Production: http://${{ secrets.AWS_VM_HOST }}"
        fi
        if [ "${{ needs.deploy-gcp-production.result }}" == "success" ]; then
          echo "  GCP Production: http://${{ secrets.GCP_VM_HOST }}"
        fi
        echo ""
        echo "ğŸ“Š Pipeline completed at: $(date)"
